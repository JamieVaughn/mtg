<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="../img/favicon.png">
    <link rel="stylesheet" href="../css/mtg.css">
    <title>Magic the Gathering Booster Pack Viewer - App Run</title>
</head>
<body>
    <!-- https://lit-html.polymer-project.org/guide/writing-templates -->
    <header>
        <img style="width:100px;height:auto;" src="https://github.com/yysun/apprun/blob/master/logo.png?raw=true">
        <h2>An experiment with (586kB) AppRun templating library for simple data hydration tasks</h2>
    </header>
    <my-cards></my-cards>
    <script type='module'>
        //  https://github.com/yysun/apprun
        import { app, Component, html } from 'https://unpkg.com/apprun@next/esm/apprun-html?module';
   

        var setCodes;

        const spinner = html`<svg width='50px' height='50px' viewBox='0 0 50 50'>
                                <circle fill="none" stroke="dodgerblue" stroke-width="4"  stroke-dasharray="45,40" cx="25" cy="25" r="15"/>
                                <animateTransform attributeName='transform' dur='0.5s' type='rotate' from='0 0 0 ' to='360 0 0' repeatCount='indefinite'/> 
                            </svg>`
                            
        class MyHeader extends Component {
            view = () => html`<h1>MTG: Booster Pack Showcase</h1>`
        }
        const handleHover = {
            handleEvent(e){
                // console.log(e.target)
                if(e.target.classList.value.includes('back')) {
                    e.target.offsetParent.classList.add('flipped')
                    setTimeout(()=>e.target.offsetParent.classList.add('done'), 600)
                } else if(e.target.classList.value.includes('content')) {
                    e.target.classList.add('flipped')
                    setTimeout(()=>e.target.classList.add('done'), 600)
                }
            },
            once: true
        }
        const handleDblClick = {
            handleEvent(e){
                let cardClasses = e.currentTarget.classList
                if(cardClasses.value.includes('lightbox')) {
                    cardClasses.remove('lightbox')
                } else {
                    cardClasses.add('lightbox')
                }
            },
            capture: true
        }
        class MyCards extends Component {
            state = {
                response: [],
                error: false
            }
            
            rendered = (props, children, state) => {
                console.log(props, children, state)
                props.response = [];
                  // https://api.magicthegathering.io/v1/sets/<setCode>/booster
                fetch('../json/setcodes.json')
                .then(resp => {
                    return resp.json()
                })
                .then(data => {
                    setCodes = data.setCodes
                    return data.setCodes[Math.floor(Math.random()*data.setCodes.length)]
                })
                .then(set => {
                    fetch(`https://api.magicthegathering.io/v1/sets/${set}/booster`)
                    .then(resp => {
                        if(resp.ok) return resp.json()
                        console.log(set)
                        fetch(`https://api.magicthegathering.io/v1/sets/CON/booster`)
                        .then(r=>r.json()).then(d=>state.response = d.cards)
                    })
                    .then(data => {
                        state.response =  data.cards
                        console.log(state.response)
                        console.log(props)
                    })
                    .catch(err => state.error = err)
                })
            }
            view = ({response, error}) => response.length ? html`
                <div>
                    <my-header @click=${rendered}></my-header>
                    <div class='showcase'>
                        ${response.map(c => html`<div class='card' @mouseover=${handleHover} @dblclick=${handleDblClick}>
                        <div class='content'>
                            <img src='../img/card_back.jpeg' class='back'/>
                            <article title='Card Set: ${c.setName}' class='front'>
                                <div class='${c.colors[0] || c.colorIdentity[0]} ${c.types.join(' ')} ${c.text && c.text.includes('Devoid') ? 'Devoid' : ''} border ${c.rarity}'>
                                    <header>
                                        <span class='name' title='${c.name}'>${c.name}</span>
                                        <span class='cost'>${c.manaCost ? html`<render-mana mana='${c.manaCost}'></render-mana>` : ''}</span>
                                    </header>
                                    <img
                                    class='magic portrait'
                                    src=${c.imageUrl ? 
                                        c.imageUrl : 
                                        'https://via.placeholder.com/200/d3d3d3/222?text=IMAGE+NOT+FOUND'} />
                                    <h3>
                                        <span class='type' title='Type: ${c.type}'>${c.type}</span>
                                    </h3>
                                    <div class='card-text ${c.text && c.text.length > 160 ? 'small-font' : ''}'>
                                        ${c.text ? c.text && c.text.match(/[\{\}]+/) ? html`<render-mana mana='${c.text}'></render-mana>` : c.text : c.flavor}
                                    </div>
                                    <footer class='footnote'>
                                        <span class='illus' title='${c.artist}'>Illus. @ ${c.artist}</span>
                                        <span class='p-t'>${c.types.includes('Creature') ? c.power + ' / ' + c.toughness : ''}</span>
                                    </footer>
                                </div>
                            </article>
                        </div>
                        </div>`)}
                    </div>
                </div>
                ` 
                : error ? html`<my-error error='${error}></my-error>` 
                : html`<my-loader></my-loader>`;
            
        }

        class MyLoader extends Component {
            view = () => html`
                <div class='loading'>
                    <h2>Fetching Magic Cards.</h3>
                    <h6>(This API is rather slow...)</h6>
                    ${spinner}
                </div>
                `
        }

        class MyError extends Component {
            view = error => html`
                    <div class='error'>
                        <h2>There was a problem fetching the cards. Attempting Contingency fetch.</h2>
                        <h5>${error}</h5>
                    </div>
                `
        }
        
        class RenderMana extends Component {
            mana = ''
            view = (mana) => html`
                    ${mana
                        .split(/[\{\}]+/)
                        .filter(i => i.length)
                        .map(m => m.length === 1 && m.match(/[BRUGWXETC0-9]/)? html`
                            <span class='mana ${m.match(/[BRUGW]/) ? 'color' : 'colorless'} ${m}'>
                                ${m.match(/[BRUGW]/) ? '' : m}
                            </span>
                        ` : html`${m}`)
                    }
                `
        }

        app.webComponent('my-header', MyHeader)
        app.webComponent('my-cards', MyCards)
        app.webComponent('my-loader', MyLoader)
        app.webComponent('my-error', MyError)
        app.webComponent('render-mana', RenderMana)
    </script>
</body>
</html>