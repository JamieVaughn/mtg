<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="../img/favicon.png">
    <link rel="stylesheet" href="../css/mtg.css">
    <title>Magic the Gathering Booster Pack Viewer - Slim.js</title>
    <!-- <script type="module" src="slim-js/Slim.js"></script>
    <script type="module" src="slim-js/directives/..."></script> -->
</head>
</head>
<body>
    <header>
        <img class='lib-logo' src="https://slimjs.com/ae609b6edbf39d3ccf48178b07c38443.png" alt="Slim.js Logo">
        <h2>An experiment with (3kB) Slim.js web component library for simple data hydration tasks</h2>
    </header>
    <my-header></my-header>
    <card-showcase></card-showcase>
    <my-tag></my-tag>
    <script type='module'>
        // https://slimjs.com/#/creating-an-element

        import {Slim} from 'https://unpkg.com/slim-js@4.0.7/Slim.js';
        // import {tag, template} from 'https://unpkg.com/slim-js@4.0.7/Decorators.js';    

        var setCodes;

        Slim.tag("my-tag",
        '<div s:if={{myBoolean}}>Now you see me</div>' +
  '<div s:if={{!myBoolean}}>Now you do not!</div>',
class MyTag extends Slim {
  onBeforeCreated() {
    this.myBoolean = true;
    setInterval(() => {
      this.myBoolean = !this.myBoolean
    }, 5000)
  }
})

        Slim.tag(
            'my-spinner',
            `<svg width='50px' height='50px' viewBox='0 0 50 50'>
                <circle fill="none" stroke="dodgerblue" stroke-width="4"  stroke-dasharray="45,40" cx="25" cy="25" r="15"/>
                <animateTransform attributeName='transform' dur='0.5s' type='rotate' from='0 0 0 ' to='360 0 0' repeatCount='indefinite'/> 
            </svg>`,
            class MySpinner extends Slim {}
        )
        Slim.tag(
            'my-header',
            `<h1>MTG: Booster Pack Showcase</h1>`,
            class MyHeader extends Slim {}    
        )
        Slim.tag(
            'card-showcase',
            `<div class='showcase'>
                <div s:if="mycards.length" s:repeat='mycards as c'>
                    <my-card bind:card={{c}}></my-card>
                </div>
                <my-error s:if="error"></my-error>
                <my-loader s:if="loading"></my-loader>
            </div>
            `,
            class CardShowcase extends Slim {
                // get useShadow() { return true } // enable ShadowDOM
                onBeforeCreated () {
                    // initializing State
                    this.error = false;
                    this.loading = true;
                    this.mycards = [];
                }
                fetchData() {
                    this.loaging = true;
                    // fetching data
                    // https://api.magicthegathering.io/v1/sets/<setCode>/booster
                    fetch('../json/setcodes.json')
                    .then(resp => {
                        return resp.json()
                    })
                    .then(data => {
                        setCodes = data.setCodes
                        return data.setCodes[Math.floor(Math.random()*data.setCodes.length)]
                    })
                    .then(set => {
                        fetch(`https://api.magicthegathering.io/v1/sets/${set}/booster`)
                        .then(resp => {
                            if(resp.ok) return resp.json()
                            console.log(set)
                            fetch(`https://api.magicthegathering.io/v1/sets/CON/booster`)
                            .then(r=>r.json()).then(d=>this.mycards = d.cards)
                        })
                        .then(data => {
                            console.log(this.error, this.mycards)
                            this.loading = false;
                            this.mycards =  data.cards
                            console.log(this.mycards)
                        })
                        .catch(err => (this.loading = false, this.error = err))
                    })
                }
                onCreated(){
                    this.fetchData()
                }
            }
        )
        const handleHover = {
            handleEvent(e){
                // console.log(e.target)
                if(e.target.classList.value.includes('back')) {
                    e.target.offsetParent.classList.add('flipped')
                    setTimeout(()=>e.target.offsetParent.classList.add('done'), 600)
                } else if(e.target.classList.value.includes('content')) {
                    e.target.classList.add('flipped')
                    setTimeout(()=>e.target.classList.add('done'), 600)
                }
            },
            once: true
        }
        Slim.tag(
            'my-card',
            `<div>
                    <div class='card' @mouseover='{{handleHover}}'>
                    <div class='content'>
                        <img src='../img/card_back.jpeg' class='back'/>
                        <article title='Card Set: {{c.setName}}' class='front'>
                            <div class='{{c.colors[0] || c.colorIdentity[0]}} {{c.types.join(' ')}} {{c.text && c.text.includes('Devoid') ? 'Devoid' : ''}} border {{c.rarity}}'>
                                <header>
                                    <span class='name' title='{{c.name}}'>{{c.name}}</span>
                                    <span class='cost'>
                                        <render-mana s:if="c.manaCost" mana='{{c.manaCost}}'></render-mana>
                                    </span>
                                </header>
                                <img
                                class='magic portrait'
                                src={{c.imageUrl || 'https://via.placeholder.com/200/d3d3d3/222?text=IMAGE+NOT+FOUND'}} />
                                <h3>
                                    <span class='type' title='Type: {{c.type}}'>{{c.type}}</span>
                                </h3>
                                <div class='card-text {{c.text && c.text.length > 160 ? 'small-font' : ''}}'>
                                    <span s:if="!c.text">{{c.flavor}}</span>
                                    <span s:if="c.text.match(/[\{\}]+/)"><render-mana mana='{{c.text}}'></render-mana></span>
                                    <span s:if="c.text">{{c.text}}</span>
                                </div>
                                <footer class='footnote'>
                                    <span class='illus' title='{{c.artist}}'>Illus. @ {{c.artist}}</span>
                                    <span class='p-t' s:if="c.types.includes('Creature')">{{c.power}} / {{c.toughness}}</span>
                                </footer>
                            </div>
                        </article>
                    </div>
                    </div>
            </div>
            `,
            class MyCard extends Slim {
                onBeforeCreated() {
                    this.c = {}
                }
            }
        )
        Slim.tag(
            'my-loader',
            `<div class='loading'>
                <h2>Fetching Magic Cards.</h3>
                <h6>(This API is rather slow...)</h6>
                <my-spinner></my-spinner>
            </div>`,
            class MyLoader extends Slim {}
        )
        Slim.tag(
            'my-error',
            `<div class='error'>
                <h2>There was a problem fetching the cards. Attempting Contignency fetch.</h2>
                <h5>{{this.error}}</h5>
            </div>`,
            class MyError extends Slim {
                onBeforeCreated() {
                    this.error = ''
                }
            }
        )
        Slim.tag(
            'render-mana',
            '<span>{{processMana(this.mana)}}</span',
            class RenderMana extends Slim {
                onBeforeCreated(){
                    this.mana = ''
                }
                processMana(mana){
                    console.log(mana)
                    mana = 'Hello World {3}{U}'
                    return mana
                            .split(/[\{\}]+/)
                            .filter(i => i.length)
                            .map(m => (
                                    m.length === 1 && m.match(/[BRUGWXETC0-9]/) ? 
                                    `<span class='mana ${m.match(/[BRUGW]/) ? 'color' : 'colorless'} ${m}'>
                                        ${m.match(/[BRUGW]/) ? '' : m}
                                    </span>` : 
                                    m
                                )
                            )


                }
            }
        )
    </script>
</body>
</html>
